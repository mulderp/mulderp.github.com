
<!doctype html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> 	
<html lang="en"> 
<!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />	<!-- Force Latest IE rendering engine -->
    <title>Building a flexible Rails Stack with Chef</title>

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href="http://feeds.feedburner.com/ThinkingOnThinking" rel="alternate" title="mulderp" type="application/atom+xml" /> 
    <link rel="shortcut icon" href="/static/images/favicon.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="javascript, backbonejs, ruby, chef, rails, erlang">

    <link rel="stylesheet" href="/static/css/style.css">

    <!--[if IE 7]>
      <script src="/static/css/font-awesome-ie7.css"></script>
    <![endif]-->
    <script tyoe="text/javascript" src="/static/js/jquery-1.6.1.min.js"></script>
  </head>
  <body>
    <div class="container">	
      <div id='mobile' class='two columns hidden'>
        <ul>
          <li><span class="gray">Patrick Mulder</span></li>
          <li><a id="mail-to-mobile" href="mailto:mulder.patrick@gmail.com" onClick="">mulder.patrick@gmail.com</a></li>
          <li><a href="http://twitter.com/mulpat" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Mobile', Sidebar Email']);">@mulpat</a></li>
        </ul>
      </div>

      <div class="four columns sidebar">
        <section>
          <a id="" style="font-size: 16px; margin-bottom: 8px; padding-bottom: 8px; font-weight: bold" href="/">thinking_on thinking</a>

          <ul id="social">
            <li>
              <a href="mailto:mulder.patrick@gmail.com?subject=hi" class="icon-envelope-alt" id="mail-to"></a>
            </li>

            <li>
              <a href="http://twitter.com/mulpat" class="icon-twitter" id="twitter" style="font-size: 28px;"></a>
            </li>

            <li>
              <a href="http://github.com/mulderp" class="icon-github" id="github" title="I share and fork code here"></a>
            </li>

            <li>
              <a href="skype:patrickmulder__?add" class="icon-comment" id="skype" title="Feel free to add me on Skype"></a>
            </li>

            <li>
              <a href="http://feeds.feedburner.com/ThinkingOnThinking" class="icon-rss" id="rss" title="RSS"></a>
            </li>
          </ul>

          <ul id="me">
            <li>Patrick Mulder</span></li>
            <li class="gray">I like Ruby. JavaScript. Vim. Chef. The Cloud.</li>
          </ul>
  
  <ul>
          <li>Get notified.</li>
          <li><form style="font-size: 8px;" action="http://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open('http://feedburner.google.com/fb/a/mailverify?uri=ThinkingOnThinking', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true"><p>Enter your email address:</p><p><input type="text" style="width:140px" name="email"/></p><input type="hidden" value="ThinkingOnThinking" name="uri"/><input type="hidden" name="loc" value="en_US"/><input type="submit" value="Subscribe" /><p>Delivered by <a href="http://feedburner.google.com" target="_blank">FeedBurner</a></p></form></li>
</ul>
        </section>
      </div>

      <article class='ten columns offset-by-four' id="article-content">
  <header class="ten columns" id="article-header">
    <h1>Building a flexible Rails Stack with Chef</h1>
    <i class="icon-tags"></i>  <a href="/tags/chef" title="View posts tagged with &quot;chef&quot;"><u>chef</u></a>     <a href="/tags/server" title="View posts tagged with &quot;server&quot;"><u>server</u></a>     <a href="/tags/chef-solo" title="View posts tagged with &quot;chef-solo&quot;"><u>chef-solo</u></a>   
  </header>

  <div class='ten columns gray' id="date-header">
    <p>
      Feb 2013
  
    </p>

  </div>

  <div class="ten columns" id="article-content">
    <p>Most of us who develop Ruby based web applications will know that the setup and configuration of a stack of web infrastructure can be tricky:</p>

<ul>
  <li>building Rubies including Gemsets often require libraries that look like strings of <a href="http://en.wikipedia.org/wiki/CAPTCHA">captcha’s</a></li>
  <li>setup of webservers (nginx or apache) have special compile flags and configuration settings too</li>
  <li>adaptors for Rack (Passenger or Unicorn nowadays) need to be built or wrapped in scripts</li>
  <li>databases are evolving (RDBMS, document-stores, key-value stores, graph db’s … ) and often come in pairs</li>
</ul>

<p>Additionally, your Unix most likely will need some essential build packages such as compilers, git, image processors, messaging queues, mailservers, etc, as well as Unix users and groups for basic security settings. Last but not least, there are different Unix distributions which bring additional surprises. </p>

<p>So, even when opinions in Rails keep some decisions simple, a web development stack might differ from the one that you or your customer will use in production.</p>

<p>With all these choices, how can you test opinions on a web stack that are good for you? </p>

<p>Particulary, how can you test opinions in the context of a database-driven web application such as Ruby-on-Rails? </p>

<p>I try to answer this with the help of 2 tools: <a href="http://docs.vagrantup.com/v1/docs/provisioners/chef_solo.html">Chef-solo</a> and <a href="http://berkshelf.com/">Berkshelf</a>.</p>

<h2 id="abstractions-in-chef">1. Abstractions in Chef</h2>

<p>What Rails is to a database-driven web application, Chef might be to infrastructure: Opinions in code. But as far as I can judge, the ecosystem of infrastructure is much more diverse, than the different components of a model-view-controller design. Let’s see how Chef attempts to abstract away the diversity in infrastructure:</p>

<ul>
  <li>
    <p>One of the most important abstractions in Chef are cookbooks. Cookbooks are similar to Gems in Ruby. Cookbooks bundle code (= “recipes”) that can be configured with “attributes” and configuration “templates”. In a way, cookbooks apply the MVC pattern: Data models are attributes, views are templates, and controllers are recipes. Cookbooks are opinionated, some more than others, but my advice for installation of services, is to look at <a href="http://community.opscode.com">community cookbooks</a> first, and then at opinions found in cookbooks found at Github.</p>
  </li>
  <li>
    <p>As we just tackle a single node setup, Vagrant and Chef-Solo are a sweet combination. Vagrant takes care of your Unix VM, and Chef-Solo can easily load cookbooks from your local environment.</p>
  </li>
  <li>
    <p>The setup of a web infrastructure stack will require multiple cookbooks, and you’ll quickly feel that downloading cookbooks yourself, and variation of cookbooks should be managed with some tool. So far, I tried 2 tools to manage cookbooks: <a href="http://berkshelf.com/">Berkshelf</a> and <a href="https://github.com/applicationsonline/librarian">Librarian-Chef</a>. Whereas Librarian manages quite well the download part, Berkshelf helps in solving package problems at hand. Think of Berkshelf as the Bundler for Ruby gems and in let’s say 80% of cases, you’ll just want to download cookbooks and can live with cookbook defaults, rather than deriving your own version of a cookbook. Berkshelf helps to abstract away the details when needed.</p>
  </li>
  <li>
    <p>Vagrant is your infrastructure lab. I wrote about some first steps with Vagrant, <a href="http://thinkingonthinking.com/An-experiment-with-Vagrant-and-Neo4J/">here</a>, <a href="http://thinkingonthinking.com/building-a-Vagrant-base-box/">here</a> and <a href="http://thinkingonthinking.com/minimum-nginx-node-with-librarian-chef/">here</a>.</p>
  </li>
</ul>

<h2 id="your-shiny-new-ruby-20-and-rails-40-beta-stack">2. Your shiny new Ruby 2.0 and Rails 4.0 beta stack</h2>

<p>I hope the abstractions above can give you some taste of what is coming up in this section. First, let’s think on a Rails application stack:</p>

<ul>
  <li>RVM to manage Rubies (could be rbenv too)</li>
  <li>Passenger to consume and respond with requests for/from Rack (could be Unicorn)</li>
  <li>PostgreSQL to deal with data storage</li>
  <li>Nginx as proxy for logging</li>
</ul>

<p>In Chef language, you would want to look at application cookbooks, such as <a href="http://community.opscode.com/cookbooks/application_ruby">application_ruby</a> or <a href="http://community.opscode.com/cookbooks/passenger_apache2">passenger_apache2</a>. Nathen Harvey shows how to get going with the passenger_apache2 cookbook in his <a href="http://www.nathenharvey.com/blog/2012/12/07/learning-chef-part-2/">blog</a>.</p>

<p>But for fun and for learning let’s look into the setup of a custom stack.</p>

<p>The dependencies for above’s stack could be defined with <a href="http://berkshelf.com/">Berkshelf</a> in the Berksfile as follows:</p>

<pre>
site :opscode

cookbook 'apt'
cookbook 'build-essential'
cookbook 'users'
cookbook 'rvm', :git =&gt; "https://github.com/fnichol/chef-rvm"
cookbook 'nginx'
cookbook 'postgresql'
</pre>

<p>Running a:</p>

<pre>
  berks install
</pre>

<p>imports the cookbooks to your local Chef environment. Next, we need to setup the Vagrantfile to use Chef-solo provisioning:</p>

<pre>
require 'multi_json'
require 'berkshelf/vagrant'

Vagrant::Config.run do |config|
  VAGRANT_JSON = MultiJson.load(Pathname(__FILE__).dirname.join('.', 'node.json').read)

  config.vm.provision :chef_solo do |chef|
    chef.cookbooks_path = ["cookbooks"]
    chef.json = VAGRANT_JSON
    chef.log_level = :debug
  
    VAGRANT_JSON['run_list'].each do |recipe|
      chef.add_recipe(recipe)
    end if VAGRANT_JSON['run_list']
  end
end
</pre>

<p>Ha, there is node.json loaded, and that is Chef’s way to define a node setup. Looking more carefully above, there are 2 details: The “run_list” and the “chef.json” part. The run_list defines, how a node conversion flows, while the json overrides attributes from cookbooks. </p>

<p>The setup of these can be tricky.</p>

<p>Here are some learnings:</p>

<ul>
  <li>
    <p>Getting a modern Ruby running is the first step for a new node. Right now, default VMs in Linux distrubtions seem Ruby 1.8.7 based. Those need an upgrade. For this, I found the cookbooks by Fletcher Nichol helpful, see <a href="https://github.com/fnichol/chef-rvm">chef-rvm</a> and <a href="https://github.com/fnichol/chef-rbenv">chef-rbenv</a>. Also, I found <a href="https://github.com/mlafeldt/ruby-cookbook">this Ruby wrapper cookbook</a> by <a href="https://twitter.com/mlafeldt">Mathias Lafeldt</a> interesting, and this is certainly on my list for further investigation.</p>
  </li>
  <li>
    <p>Passenger is a Ruby gem that is partly compiled into Nginx or loaded as module in Apache. Let’s look at the nginx setup. The tricky parts are the system paths, thanks a lot to <a href="https://twitter.com/jtimberman">@jtimberman</a> for helping me understand this better. There are interesting details behind this in yesterday’s <a href="http://www.youtube.com/watch?v=ddMLvMvOUfg&amp;feature=youtu.be">office hours with Joshua</a>.</p>
  </li>
</ul>

<pre>
  ...
  "nginx": {
    "version": "1.2.5",
    "user": "deploy",
    "init_style": "init",
    "modules": [
      "http_stub_status_module",
      "http_ssl_module",
      "http_gzip_static_module"
    ],
    "passenger": {
      "version": "3.0.18",
      "gem_binary": "/usr/local/rvm/wrappers/ruby-2.0.0-p0/gem"
    },
    "configure_flags": [
      "--add-module=/usr/local/rvm/gems/ruby-2.0.0-p0/gems/passenger-3.0.18/ext/nginx"
    ],
  ...
</pre>

<ul>
  <li>Add some gems that you mostly will need: Rake, Bundler and Rails:</li>
</ul>

<pre>
  ...
  "rvm": {
    "rubies": ["2.0.0-p0"],
    "default_ruby": "2.0.0-p0",
    "vagrant": { "system_chef_solo" : "/opt/ruby/bin/chef-solo" },
    "gems": {
      "1.9.3-p0": [
        {"name": "bundler"},
        {"name": "rake"},
        {"name": "rails", "version": "4.0.0.beta1" }
      ]
    }
  ...
</pre>

<p>Maybe there are more details, but maybe you are curious to just see the <a href="https://github.com/mulderp/chef-rails-stack/tree/rails4_stack">chef-rails-stack</a> at work.</p>

<p>Let’s try a provisioning.</p>

<pre>
  $ bin/vagrant up
  $ bin/vagrant ssh
</pre>

<p>And:</p>

<pre>
  vagrant@Ubuntu-11:~$ ruby -v
  ruby 2.0.0p0 (2013-02-24 revision 39474) [x86_64-linux]
  vagrant@Ubuntu-11:~$ rails -v
  Rails 4.0.0.beta1
</pre>

<p>So, what do you think? There is more tuning needed, like setup of the nginx virtual host that connect to the Rails application. Also, the nginx conversion step might break, and users are missing. Any feedback would be interesting. Thanks for reading and sharing!</p>


  </div>

  <footer class="ten columns">
    <p>
    <a class="btn btn-mini btn-info" href="https://github.com/mulderp/mulderp.github.com/issues/new" title="Leave feedback using GitHub" target="_blank"><i class="icon-comment icon-white"></i> Leave me feedback</a>
    </p>
    <p id='follow'>
      Follow me on Twitter <a href="http://twitter.com/mulpat" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Post Twitter']);">here.</a>
    </p>
    <p>
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="mulpat">Tweet</a>
       
      <!-- Put this just before the closing body tag -->
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </p>
    <p>
       <!-- Google + -->
       <p><g:plusone size="medium"></g:plusone></p>
        
       <!-- Add this just before the closing body tag of your web page -->	
       <script type="text/javascript">
         (function() {
           var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
           po.src = 'https://apis.google.com/js/plusone.js';
           var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
         })();
       </script>
    </p>
  </footer>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'thinkingonthinking'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
 
</article>
<script src="../static/js/disqus.js" type="text/javascript"></script>
<script type="text/javascript">
  var analytics=analytics||[];analytics.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+e+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);var r=function(e){return function(){analytics.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["identify","track","trackLink","trackForm","trackClick","trackSubmit","pageview","ab","alias"];for(var s=0;s<i.length;s++)analytics[i[s]]=r(i[s])};
  analytics.load("t2dez1p4gw");
  analytics.track('Post', {
      title: "Building a flexible Rails Stack with Chef"
    });
</script>

    </div>

<script type="text/javascript">
  var analytics=analytics||[];analytics.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+e+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);var r=function(e){return function(){analytics.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["identify","track","trackLink","trackForm","trackClick","trackSubmit","pageview","ab","alias"];for(var s=0;s<i.length;s++)analytics[i[s]]=r(i[s])};
  analytics.load("t2dez1p4gw");
  $(document).ready(function() {
    analytics.trackLink( $("#mail-to"), 'mail_event', {source:"main"});
    analytics.trackLink( $("#github"), 'contact-github', {source:"main"});
    analytics.trackLink( $("#skype"), 'contact-skype', {source:"main"});
    analytics.trackLink( $("#rss"), 'contact-rss', {source:"main"});
  });
</script>
  </body>
</html> 
